## 沪美专线高可用搭建教程

### 概述

很多优质的VPS商家（如DMIT、NUBE等）都提供全球内网连接服务，这为我们构建高质量的国际网络专线创造了绝佳的条件。本教程将详细介绍如何充分利用商家提供的全球内网资源，结合IX专线，实现从上海到美国的高可用网络专线，并支持入站代理，实现全球最优延迟。

### 网络架构设计

我们的目标是构建一个多层级、高可靠的网络转发架构：

```
上海BGP接入 → 沪日IX转发组 → 日美内网专线组 → 美国落地服务组
```

**架构优势：**
- **高可用性**：多路径冗余，单点故障不影响整体服务
- **低延迟**：利用商家内网专线，避免公网绕路
- **灵活扩展**：支持多商家、多线路混合组网
- **智能调度**：自动选择最优路径进行数据转发

**关键组网思路：** 日美内网组是整个架构的核心，包含多条并行链路：
- **NUBE专线**：日本NUBE节点 → 美国NUBE节点
- **DMIT专线**：日本DMIT节点 → 美国DMIT节点

通过这种设计，我们实现了双重保障。正如经典的网络工程原则：**没有什么网络问题是不能通过增加一个转发节点和端口转发来解决的。如果有，那就再加一个！**

### 步骤一：创建DMIT日美内网转发端点

首先，我们需要为DMIT的日美内网连接创建一个专用的转发端点。

<img src="https://img.coderluny.com:444/uploads/e6c8bb01-07be-4157-9f41-79ed116bdee3.png" width="600" alt="创建DMIT转发端点">

**配置说明：**
- **端点名称**：建议使用有意义的命名，如 "DMIT-JP-US-Relay"
- **IP地址**：初始阶段可以随意填写，后续会根据实际的转发IP和端口进行修改
- **用途**：作为日本到美国的内网专线跳板

创建完成后，系统会自动分配一个监听端口，本例中分配的端口号为：**48350**

<img src="https://img.coderluny.com:444/uploads/e44637e1-1327-4898-8966-d4a543d76d7d.png" width="600" alt="查看分配的端口号">

### 步骤二：配置端口转发规则

接下来配置从DMIT日本节点到DMIT美国节点的端口转发规则：

<img src="https://img.coderluny.com:444/uploads/65ed74c0-7d9b-4d7a-b769-f01640b04616.png" width="600" alt="添加端口转发规则">

**转发配置要点：**
- **源端点**：DMIT日本服务器
- **目标端点**：DMIT美国服务器  

配置完成后，记录关键信息：
- **日本节点监听端口**：31784
- **转发目标**：美国DMIT服务器

<img src="https://img.coderluny.com:444/uploads/0acdb3a2-0c2e-4a27-a675-667ded62bbad.png" width="600" alt="记录端口信息">

### 步骤三：更新转发端点配置

根据实际的转发链路信息，更新之前创建的转发端点：

<img src="https://img.coderluny.com:444/uploads/63a6caf3-4b86-48cb-8dd9-d41348ee0004.png" width="600" alt="修改转发端点信息">

**重要配置项：**
- **转发IP**：更新为DMIT日本节点的IP
- **服务端口**：设置为步骤二中记录的端口 31784
- **绑定端口**：可与你随意填写一个没有使用的，也可以和之前的一样。



### 步骤四：部署美国落地节点

完成端点配置后，需要在DMIT美国服务器上安装并启动转发端点程序：

**扩展配置：** 按照同样的方法可以添加NUBE内网专线，然后将DMIT和NUBE两条线路放入同一个端点组中，实现多路径负载均衡。本教程为简化演示，仅配置DMIT专线。

### 步骤五：创建高可用端点组

为了实现高可用性和负载分担，我们需要创建一个端点组来统一管理多个转发端点：

<img src="https://img.coderluny.com:444/uploads/e6025570-15d8-484e-ac87-398b969e5f3f.png" width="600" alt="创建端点组">

**端点组配置：**
- **成员节点**：包含所有日美专线转发端点

### 步骤六：配置转发链和入站代理

创建端口转发规则，并启用转发链模式以实现多级转发：

<img src="https://img.coderluny.com:444/uploads/d82bbaf3-fac5-41e1-bc10-444c29719665.png" width="600" alt="配置转发链模式">

**转发链配置要点：**
- **转发模式**：启用转发链（Forward Chain）
- **链路路径**：上海BGP → 日本IX → 日美内网组 → 美国落地
- **（可选）开启智能选择**： 避免因为ix挂掉而影响整体链路连通性

启用入站代理功能，提供统一的接入点：

<img src="https://img.coderluny.com:444/uploads/5f891e4e-c2c1-442e-94a1-8e0fbe514914.png" width="600" alt="启用入站代理">

**入站代理优势：**
- **统一接入**：客户端只需连接一个代理地址
- **智能路由**：自动选择到达访问目标的最优转发路径  

### 步骤七：性能测试和优化

配置完成后，进行链路质量测试：

<img src="https://img.coderluny.com:444/uploads/224dd880-9bf9-4fa6-9ed5-b4178de21f2c.png" width="600" alt="延迟测试结果">

**测试说明：**
- **测试方法**：当前使用TCPPING进行延迟测试
- **结果分析**：TCPPING测试的延迟通常比实际应用延迟偏低

### 总结

通过以上步骤，我们成功构建了一条高可用的沪美网络专线，实现了：

- **多路径冗余**：DMIT和NUBE双线路保障
- **智能调度**：自动故障切换和负载均衡
- **低延迟传输**：利用商家内网避免公网绕路
- **灵活扩展**：支持后续添加更多线路和节点

这种架构适用于对网络质量要求较高的业务场景，如在线游戏、视频会议、金融交易等应用。